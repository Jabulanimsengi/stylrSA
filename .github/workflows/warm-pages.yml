name: Page Warming

on:
  # Run every 6 hours
  schedule:
    - cron: '0 */6 * * *'
  
  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      start_from:
        description: 'Start from page number'
        required: false
        default: '0'
      limit:
        description: 'Number of pages to warm'
        required: false
        default: '15000'
      concurrency:
        description: 'Concurrent requests'
        required: false
        default: '5'

jobs:
  # Job 1: Pages 0-15,000 (Priority pages)
  warm-batch-1:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hour max
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Run Page Warming Script
        working-directory: frontend
        env:
          BASE_URL: https://www.stylrsa.co.za
        run: |
          echo "ðŸ”¥ Starting page warming batch 1 (pages 0-15000)"
          node scripts/warm-pages.js \
            --start-from ${{ github.event.inputs.start_from || '0' }} \
            --limit ${{ github.event.inputs.limit || '15000' }} \
            --concurrency ${{ github.event.inputs.concurrency || '5' }}

  # Job 2: Pages 15,000-30,000
  warm-batch-2:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    needs: warm-batch-1  # Wait for batch 1 to complete
    if: github.event_name == 'schedule'  # Only run on schedule, not manual
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Run Page Warming Script
        working-directory: frontend
        env:
          BASE_URL: https://www.stylrsa.co.za
        run: |
          echo "ðŸ”¥ Starting page warming batch 2 (pages 15000-30000)"
          node scripts/warm-pages.js --start-from 15000 --limit 15000 --concurrency 5

  # Job 3: Pages 30,000-45,000
  warm-batch-3:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    needs: warm-batch-2
    if: github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Run Page Warming Script
        working-directory: frontend
        env:
          BASE_URL: https://www.stylrsa.co.za
        run: |
          echo "ðŸ”¥ Starting page warming batch 3 (pages 30000-45000)"
          node scripts/warm-pages.js --start-from 30000 --limit 15000 --concurrency 5

  # Job 4: Pages 45,000-60,000
  warm-batch-4:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    needs: warm-batch-3
    if: github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Run Page Warming Script
        working-directory: frontend
        env:
          BASE_URL: https://www.stylrsa.co.za
        run: |
          echo "ðŸ”¥ Starting page warming batch 4 (pages 45000-60000)"
          node scripts/warm-pages.js --start-from 45000 --limit 15000 --concurrency 5

  # Job 5: Pages 60,000-77,393 (remaining)
  warm-batch-5:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    needs: warm-batch-4
    if: github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Run Page Warming Script
        working-directory: frontend
        env:
          BASE_URL: https://www.stylrsa.co.za
        run: |
          echo "ðŸ”¥ Starting page warming batch 5 (pages 60000+)"
          node scripts/warm-pages.js --start-from 60000 --limit 20000 --concurrency 5
